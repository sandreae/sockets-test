<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel='stylesheet' href='/css/stylesheet.css' />
    <title>LIEBIG12_TEST</title>
  </head>
  <body>
    <p id='loading'>loading.....</p>
    <script src="/socket.io/socket.io.js"></script>
    <video id="myVideo1" width="320" height="176" loop muted playsinline>
      <source src="videos/black.mp4" type="video/mp4">
      Your browser does not support HTML5 video.
    </video>
    <video id="myVideo2" width="320" height="176" loop muted playsinline poster="/images/fuck1.png">
      Your browser does not support HTML5 video.
    </video>
    <button id="start">Go!</button>

<script> 

    var fresh = true
    var socket = io();
    var video1 = document.getElementById("myVideo1");
    var video2 = document.getElementById("myVideo2");
    var videoArray = [video1, video2]
    var audioArray = []
    var button = document.getElementById('start');
    var loading = document.getElementById('loading');

    window.addEventListener('click', function(){
      audioArray[0].start(0)
      audioArray[1].start(0)
      button.style.display = "none"
    });

    window.addEventListener('keydown', function(event){
      if (event.keyCode == 32){
        socket.emit('bang');
      }
    });

    socket.on('play', function (track) {
      console.log("play")
      console.log(track)
      videoArray[track].play();
      videoArray[track].style.display = "inline";
      audioArray[track].connect(context.destination)
    });

    socket.on('stop', function (track) {
      if (fresh !== true) {
        console.log("stop")
        console.log(track)
        videoArray[track].pause();
        videoArray[track].style.display = "none";
        audioArray[track].disconnect(context.destination)
      } else {
        fresh = false;
      }
    })

    function getRandomColor() {
    var letters = '0123456789ABCDEF';
    var color = '#';
    for (var i = 0; i < 6; i++) {
      color += letters[Math.floor(Math.random() * 16)];
    }

    return color;
    }
    </script>

    <script type="text/javascript">

      window.onload = init;
      var context;
      var bufferLoader
      var sources = {}

      function init() {
        // Fix up prefixing
        window.AudioContext = window.AudioContext || window.webkitAudioContext;
        context = new AudioContext();

        bufferLoader = new BufferLoader(
          context,
          [
            'audio/organ.mp3',
            'audio/squeak.mp3'
          ],
          finishedLoading
          );
        bufferLoader.load();
      }

      function finishedLoading(bufferList) {
        // Create two sources and play them both together.
        var source1 = context.createBufferSource();
        var source2 = context.createBufferSource();
        source1.buffer = bufferList[0];
        source2.buffer = bufferList[1];
        source1.loop = true;
        source2.loop = true;

        loading.style.display = "none"
        button.style.display = "inline"

        // source1.connect(context.destination);
        // source2.connect(context.destination);

        audioArray = [source1, source2]

      }
    </script>

    <script type="text/javascript">
      function BufferLoader(context, urlList, callback) {
  this.context = context;
  this.urlList = urlList;
  this.onload = callback;
  this.bufferList = new Array();
  this.loadCount = 0;
}

BufferLoader.prototype.loadBuffer = function(url, index) {
  // Load buffer asynchronously
  var request = new XMLHttpRequest();
  request.open("GET", url, true);
  request.responseType = "arraybuffer";

  var loader = this;

  request.onload = function() {
    // Asynchronously decode the audio file data in request.response
    loader.context.decodeAudioData(
      request.response,
      function(buffer) {
        if (!buffer) {
          alert('error decoding file data: ' + url);
          return;
        }
        loader.bufferList[index] = buffer;
        if (++loader.loadCount == loader.urlList.length)
          loader.onload(loader.bufferList);
      },
      function(error) {
        console.error('decodeAudioData error', error);
      }
    );
  }

  request.onerror = function() {
    alert('BufferLoader: XHR error');
  }

  request.send();
}

BufferLoader.prototype.load = function() {
  for (var i = 0; i < this.urlList.length; ++i)
  this.loadBuffer(this.urlList[i], i);
}


    </script>
  </body>
</html>